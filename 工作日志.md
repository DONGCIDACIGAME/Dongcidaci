# 2023/04/02 
代码设计更改的一些想法

1. 【DONE】agent status 里的逻辑挪到具体的status里
2. ~~move control 挪到具体的status里，例如idle里的inputcontrol就不会控制移动，run status里，input control只控制转向，只要在run里，就会以speed的速度朝着角色朝向移动。~~  `2023/04/07 move control还在agent里，但是驱动逻辑放在了各个status里`
3. 每个status里添加一个命令队列（考虑直接使用一个数组，或者一个int，每一位表示一个指令），在status的onaction里，判断每种action是直接执行还是要放入指令队列中，对于放入指令队列中的指令，在每个节拍上去处理，这里又要根据status去区分处理，比如有些状态是可以打断的，例如一个runloop占2拍，要进入idle状态，就在第一拍的时候就打断，进入idle。是否打断，也要看当前状态和目标指令之间的关系，例如一个攻击假如占4拍，指令是idle，那就是不能打断的，如果指令xxx，可能就能打断。
4. 【input control也要挪到status里，每个status的input逻辑单独控制。input检测到的指令，处理逻辑参考上一条】待定  目前先放在agent里


# 2023/04/05
1. 【DONE】2023/04/02 工作中的1已经完成初步迁移，还需要进行代码优化和重构
2. 【DONE】2023/04/02 工作中的2经过思考，应该是必要的
3. 【DONE】2023/04/02 工作中的3已经完成初步迁移，还需要进行代码优化和重构
4. 【DONE】2023/04/02 工作中的4再思考一下是否要放到每个status里
5. 【DONE】玩家的指令需要新增一个缓存池，缓存池的指令添加和删除逻辑需要再思考细化一下
6. 【DONE】游戏音乐已更换为HIFI RUSH中的一段
7. 节拍逻辑做了部分调整，所有注册到节拍管理器中的handler，都在节拍到来并完成节拍index自增后再进行调用，保证OnMeter(int meterIndex)里的节拍是当前节拍的index，【TODO】思考是否需要加第0拍和最后一拍
8. 【TO_CHK】全部都使用节拍没有问题，但是如果配合定时器使用，怎么保证定时器结束时是想要的拍子？可能定时器结束比节拍器的调用要早，应该可以通过控制定时器中心的update和节拍管理器的update的调用顺序来保证，看下代码
9. 【TO_CHK】现在有节拍index，但是由于有音乐循环，循环处的index会归零，导致有些逻辑不同通过index去做，想一下怎么处理优化

# 2023/04/06
1. 【DONE】增加角色命令缓存池
2. 【TO_OPT】角色命令部分代码优化 
3. 【TODO】agentanimqueue需要重构，并不是每种状态退出时都要清animqueue的状态，例如连击的combo，就需要根据连击的结果去处理动画（attack 可能会在期间切到idle）
4. 【TODO】新增一个combo处理器，具体逻辑待开发

# 2023/04/07
1. 【TODO】是combo配置攻击动画播哪个，还是动画配置里定好，combo只负责连击时move next----配在combo里
2. 【TODO】节拍和按下的逻辑
![节拍和按下](./工作日志图片/节拍和按下.jpg)
情况1: 在节拍前按下按键</br>
情况2：在节拍上按下按键</br>
情况3：在节拍后按下按键</br>
问题：只考虑动画播放的问题，不考虑是否在节拍的有效时间内按下。情况1，2,3播放攻击动画，如果都按照接下来最近的一拍去卡攻击动画的拍子，会出现第一拍攻击频率差异很大的情况，加小动画也不能解决该问题，还会带来连招的出招问题，强行加的话感觉这里的逻辑会变得非常复杂，需要一套简单且具有普遍性的动画规则</br>
建议：按下时，计算当前到下个最近节拍的时间，对每个动作设定一个最快的播放速度，如果按照上面计算出的时间来完整播放动画，且速度超过了最快速度，就说明距离下一拍比较近，不会立即进行攻击，而是从下一拍开始播放攻击动画</br>

3. 【TO_DIS】combo中是否会有空拍，应该怎么处理
--------动画结束时停留在结束帧，空拍切回idle状态

# 2023/04/10
1. 【DONE】--------情况1--拍子前最多等待0.2s</br>
【DONE】--------情况3--需要的播放时长/理论播放播放时长 >=0.8直接播</br>
【TODO】--------情况4--做个起手等待动画</br>
2. ~~新问题 跑的时候切idle，左脚停和右脚停，两个切的动画应该不一样，现在用的是idle的默认动画，切换的时候会有点奇怪~~
3. 【DONE】keyboardInputControl全局只有一份，但是inputhandle需要在status初始化时注册进来，切换状态时同时切换inputhandle的enable状态，inputcontrol驱动inputhandle的update，inputhandle处理各自的输入逻辑
4. ~~攻击的输入时间，分为三种情况，怎么处理？ 输入时间内，默认状态是EMPTY，之外的时间，默认状态是IDLE，想一下不是攻击状态这个机制是否也适用~~`攻击输入的前半段时间，动画还在播放，不用管，后半段时间保持攻击动画的最后一帧，过了攻击输入的后半段，还没有输入，就进入idle（特殊情况：如果输入控制的时间调的很长，输入的后半段超过了整个节拍时间，就会出现播完攻击动画后一直卡在最后一帧的情况，所以做了个最长的静止时间的限定，目前是0.2s，即min(输入容差，0.2）是保持动画最后一帧的时间`


# 2023/04/11
1. 以下几个动作是否等拍子需要去游戏中体验一下
    1. RUN
    2. JUMP (仅参考)
    3. DASH
    4. ATTACK
    5. BLOCK (仅参考)
    6. IDLE
2. 动画转换的情况分类：
    1. 等待：等下一拍再切换
    2. 条件等待：
        1. 本拍的剩余时间超过本拍的80%时直接切换
        2. 其他都等下一拍切换
    3. 直接切换
2. 关于状态切换的想法： 
    1. IDLE     ->      IDLE     等待
    1. IDLE     ->      RUN      直接切换
    2. IDLE     ->      ATTACK   条件等待
    3. IDLE     ->      DASH     直接切换
    3. IDLE     ->      BE_HIT   直接切换
    3. RUN      ->      RUN      等待
    3. RUN      ->      ATTACK   条件等待
    3. RUN      ->      DASH     直接切换
    3. RUN      ->      IDLE     直接切换
    3. RUN      ->      BE_HIT   直接切换
    3. ATTACK   ->      ATTACK   条件等待
    3. ATTACK   ->      RUN      等待
    3. ATTACK   ->      DASH     等待
    3. ATTACK   ->      IDLE     等待
    3. ATTACK   ->      BE_HIT   直接切换
    3. DASH     ->      DASH     等待
    3. DASH     ->      RUN      等待
    3. DASH     ->      ATTACK   条件等待
    3. DASH     ->      IDLE     直接切换
    3. DASH     ->      BE_HIT   直接切换
    3. BE_HIT   ->      IDLE     等待
    3. BE_HIT   ->      RUN      等待
    3. BE_HIT   ->      ATTACK   等待
    3. BE_HIT   ->      DASH     等待
    3. BE_HIT   ->      BE_HIT   直接切换
3. 关于输入控制的想法：
    1. 每个攻击动画结束时，理论上是卡拍子结束的，动画结束时默认停在最后一帧不动，如果在攻击输入的时间范围内检测到攻击，则接上上次攻击进行，如果在这个时间范围内没有检测到攻击，就进入idle状态。因此attack状态下的输入控制，做如下设计

        ```

        b0           b1           b2           b3           b4
        |------------|------------|------------|------------|
                |        |   |        |   |        |
                | atkchk |   | atkchk |   | atkchk |
        |-----ATK----|-00-|
        1.       |---K----|--ATK--|(条件等待)
        2.       |---R+K--|-T-ATK-|(条件等待)
        3.       |---R----|-T-RUN-|(条件等待)
        4.       |---D----|--DS---|(条件等待)
        5.       |--------|-IDLE--|(不等)

        b:      节拍位置
        atkchk: 攻击检测
        atkanim:攻击动画
        0:维持之前额动画状态
        K: 攻击按下
        R: 方向键按下
        D: 冲刺键按下
        T: 转向动画
        ATK: 攻击动画
        DS:冲刺动画
        RUN: 跑动画
        IDLE: 空闲动画
        ```

    # 2023/04/12
    1. 【DONE】动画融合机制更改，动画融合改为CrossFadeInFixedTime，动画融合时，新动画的播放速度按照正常全量拍子的时长去计算，新动画做了偏移以保证融合后动画卡点，目前按照这个机制去融合效果还可以
        ```
            /*
         *  假如是一个2拍的动画
         *  1.原始动画时长
         * |----------------|----------------|
         * 
         *  2.按照节拍播完的时长
         * |----------|----------|
         * 
         * 3.游戏进程  0:开始融合  >:融合过程
         * |----------------|----------------|----------------|----------------|----------------|
         * |------0>>-------|----------------|
         *  A动画     B动画
         *         |-------------------------| inTime（想要动画播放的时长）
         *         |--------------------------------|totalMeterLen（B动画原始时长）
         *                                   |------|timeOffset（把B动画向前移动的时长）
         *                                                    
         * 由1，2可以计算出一个动画播放的速度，按照这个速度播放可以保证动画在游戏的两拍内播完
         * 由3可以计算出动画的偏移时长，向前偏移后可以保证动画在节拍处播放完成
         * 动画的融合时间是一个独立值，只是融合过程需要花多久，上面两步是保证卡点的关键计算
         */
        ```
    # 2023/04/12
    1. 【DONE】状态切换的规则再思考确认
    2. 【DONE】把状态切换的逻辑抽成独立方法· `目前抽成了4个方法 1.按照节拍进度条件等待 2.按照节拍剩余时间条件等待 3.立即执行 4.等节拍`
    3. ~~【DONE】目前攻击输入上下容差是0.2s， 但是很难触发，理论上不应该会这么难的，打印日志看下问题原因~~
    4. 【TODO】每个status的input逻辑再整理一下，例如攻击输入时间内可以进行转向操作`节拍处检测一次，只有节拍处有按了方向键，才能改变攻击方向`，攻击过程是否有少量的前移？攻击完成->输入时间截至的这段时间内，动画停止的逻辑
    5. 【TODO】制作场景物体随音乐律动的逻辑脚本 （mono脚本，挂载式）
        1. ~~【DONE】随音乐缩放（分奇数拍和偶数拍）~~`新机制，见2023/04/14`
        2. ~~【DONE】随音乐运动（上下左右）~~`新机制，见2023/04/14`
        3. 随音乐播放特效
        4. 等等 待补充

    # 2023/04/13
    1. 【DONE】攻击动作结束时停在最后一帧，等输入检测结束再进入idle  这里的机制  检测本拍的前半部分输入检测，输入检测时间，定个最大值，超过这个值也进入到idle

    # 2023/04/14
    1. 【DONE】随音乐缩放、移动的脚本已完成，不再使用奇偶机制，而改为配置不同节奏型下的触发设置，目前支持3拍，4拍和8拍的节奏型，应该可以涵盖所需要的绝大部分场景
    2. 【DONE】音乐节拍文件中新加入字段：节奏型 可设置为 3:3拍  4:4拍  8:8拍 
    3. 【TODO】后续还需要加入自定义，每个节拍的数据，以后不仅仅是节拍的时间戳，~~还需要加入触发类型等相关信息，后续根据需求加入，自定义的这种节奏了型，就需要再OnMeter里，读取meter的触发（应该是0,1）~~
    4. 【TODO】需要加入随节拍播放特效或者生成预制件的mono脚本
    5. 【TODO】添加Dash状态  dash手感不好，需要调教
    6. 【TODO】AgentStatus  中 OnCommands和CommandHandleOnMeter是否能重构

    # 2023/04/16
    1. 攻击动画测试，建议改为  0-0-0-0-0.1-0.2.0.3-0.4-0.5-0.6-0.7-0.8-0.9.1.0，数组代表动画的帧代表的动画进度，及开始的几帧是起手的定格帧，接下来是正常的攻击动画，结束帧一定是hit帧
    2. 【DONE】律动不再配置在挂载的脚本上，改为跟随音乐进行配置，音乐的配置文件中配置触发的节奏型
    ~~2. 支持使用自定义配置的律动触发器， 感觉这里需要重构一下，改为传入触发器。做几个类型的触发器就行~~
    3. 【DONE】支持使用自定义的触发数组
    4. 【TODO】UI上制作节拍提示器，先做一个简易的
    5. 【TODO】编写包围盒逻辑，理论上做2D的就行
    6. 【TODO】编写碰撞逻辑，碰撞中心-所有有碰撞的物件注册进碰撞中心-在碰撞中心的update里，每个碰撞体和所有其他碰撞体做碰撞检测，如果发生碰撞，则进行碰撞处理。先使用接口
    7. 【待研究】动画融合时发现融合的旋转方向反了，然而前后衔接的两个动画的旋转值其实差不太多，需要研究下到底问题出在哪里
        
