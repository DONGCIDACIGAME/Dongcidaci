# 2023/04/02 
代码设计更改的一些想法

1. agent status 里的逻辑挪到具体的status里  
2. move control 挪到具体的status里，例如idle里的inputcontrol就不会控制移动，run status里，input control只控制转向，只要在run里，就会以speed的速度朝着角色朝向移动。  
3. 每个status里添加一个命令队列（考虑直接使用一个数组，或者一个int，每一位表示一个指令），在status的onaction里，判断每种action是直接执行还是要放入指令队列中，对于放入指令队列中的指令，在每个节拍上去处理，这里又要根据status去区分处理，比如有些状态是可以打断的，例如一个runloop占2拍，要进入idle状态，就在第一拍的时候就打断，进入idle。是否打断，也要看当前状态和目标指令之间的关系，例如一个攻击假如占4拍，指令是idle，那就是不能打断的，如果指令xxx，可能就能打断。
4. 【input control也要挪到status里，每个status的input逻辑单独控制。input检测到的指令，处理逻辑参考上一条】待定  目前先放在agent里


# 2023/04/05
1. 【TO_OPT】2023/04/02 工作中的1已经完成初步迁移，还需要进行代码优化和重构
2. 【TODO】2023/04/02 工作中的2经过思考，应该是必要的
3. 【TO_OPT】2023/04/02 工作中的3已经完成初步迁移，还需要进行代码优化和重构
4. 【TO_CHK】2023/04/02 工作中的4再思考一下是否要放到每个status里
5. 【TODO】玩家的指令需要新增一个缓存池，缓存池的指令添加和删除逻辑需要再思考细化一下
6. 【DONE】游戏音乐已更换为HIFI RUSH中的一段
7. 节拍逻辑做了部分调整，所有注册到节拍管理器中的handler，都在节拍到来并完成节拍index自增后再进行调用，保证OnMeter(int meterIndex)里的节拍是当前节拍的index，【TODO】思考是否需要加第0拍和最后一拍
8. 【TO_CHK】全部都使用节拍没有问题，但是如果配合定时器使用，怎么保证定时器结束时是想要的拍子？可能定时器结束比节拍器的调用要早，应该可以通过控制定时器中心的update和节拍管理器的update的调用顺序来保证，看下代码
9. 【TO_CHK】现在有节拍index，但是由于有音乐循环，循环处的index会归零，导致有些逻辑不同通过index去做，想一下怎么处理优化

# 2023/04/06
1. 【DONE】增加角色命令缓存池
2. 角色命令部分代码优化 
3. 【TODO】agentanimqueue需要重构，并不是每种状态退出时都要清animqueue的状态，例如连击的combo，就需要根据连击的结果去处理动画（attack 可能会在期间切到idle）
4. 【TODO】新增一个combo处理器，具体逻辑待开发

# 2023/04/07
1. 【TO_DIS】是combo配置攻击动画播哪个，还是动画配置里定好，combo只负责连击时move next----配在combo里
2. 【TO_DIS】节拍和按下的逻辑
![节拍和按下](./工作日志图片/节拍和按下.jpg)
情况1: 在节拍前按下按键</br>
情况2：在节拍上按下按键</br>
情况3：在节拍后按下按键</br>
问题：只考虑动画播放的问题，不考虑是否在节拍的有效时间内按下。情况1，2,3播放攻击动画，如果都按照接下来最近的一拍去卡攻击动画的拍子，会出现第一拍攻击频率差异很大的情况，加小动画也不能解决该问题，还会带来连招的出招问题，强行加的话感觉这里的逻辑会变得非常复杂，需要一套简单且具有普遍性的动画规则</br>
建议：按下时，计算当前到下个最近节拍的时间，对每个动作设定一个最快的播放速度，如果按照上面计算出的时间来完整播放动画，且速度超过了最快速度，就说明距离下一拍比较近，不会立即进行攻击，而是从下一拍开始播放攻击动画</br>
--------情况1--拍子前最多等待0.2s</br>
--------情况3--需要的播放时长/理论播放播放时长 >=0.8直接播</br>
--------情况4--做个起手等待动画</br>
3. 【TO_DIS】combo中是否会有空拍，应该怎么处理
--------动画结束时停留在结束帧，空拍切回idle状态

# 2023/04/10
1. 情况1 情况3已完成
2. 新问题 跑的时候切idle，左脚停和右脚停，两个切的动画应该不一样，现在用的是idle的默认动画，切换的时候会有点奇怪